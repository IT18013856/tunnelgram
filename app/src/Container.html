<svelte:window on:resize="updateNavbarHeight()"></svelte:window>
<div class="{$user ? 'd-flex flex-column' : ''}" style="height: {$user ? '100vh' : 'auto'}; padding-top: {_navbarHeight}px;">
  {#if !_storageAvailable}
    <div class="container">
      <h1>Your browser doesn't support the localStorage API. {brand} will not work on this browser!</h1>
    </div>
  {/if}
  {#if !_cryptoAvailable}
    <div class="container">
      <h1>Your browser doesn't support the Crypto API. {brand} will not work on this browser!</h1>
    </div>
  {/if}
  {#if $user === false}
    <div class="container" style="height: 100vh;">
      <div class="row align-items-center justify-content-center" style="height: 100vh;">
        <div class="col-auto">
          <LoadingIndicator width="300px" height="300px" title="Tunnelgram" text="Easy, secure messenger." />
        </div>
      </div>
    </div>
  {/if}
  {#if $user !== false}
    <nav ref:navbar class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <span class="navbar-brand {$user ? 'd-md-flex d-none' : ''} align-items-center">
          <span>{brand}</span>
          <span class="badge badge-warning ml-1" style="font-size: .6em;">beta</span>
        </span>
        {#if $user}
          <ul class="navbar-nav d-lg-none">
            <li class="nav-item">
              <a class="nav-link border-secondary rounded px-2" href="javascript:void(0)" on:click="handleConvoClick()">
                <i class="fas fa-comments"></i>
              </a>
            </li>
          </ul>
          <span class="navbar-text">
            {name}
          </span>
          <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" on:click="updateNavbarHeightLots()">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <NavBar></NavBar>
            <ul class="navbar-nav ml-auto">
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle p-0" href="javascript:void(0)" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <img
                    class="rounded-circle"
                    src="{$userAvatar ? $userAvatar : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoAgMAAADxkFD+AAAACVBMVEXMzMyWlpa3t7fI5tFIAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAF0lEQVQYlWNgGOagiQPOdGQZQHdQGQAArI4A0FwgBeUAAAAASUVORK5CYII='}"
                    alt="{$user.data.nameFirst}" />
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
                  <h6 class="dropdown-header">
                    {$user.data.name}
                  </h6>
                  <a class="dropdown-item" href="javascript:void(0)" data-toggle="modal" data-target="#accountInfoModal">
                    Account Info
                  </a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="javascript:void(0)" on:click="$set({decryption: !$decryption})" use:tooltip data-toggle="tooltip" data-html="true" title="See what a <strong>hacker</strong> would see if they hacked into your account.">
                    <input type="checkbox" checked="{!$decryption}" readonly /> Hacker Mode
                  </a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="javascript:void(0)" on:click="$logout()">
                    Log Out
                  </a>
                  {#if $userIsTilmeldAdmin}
                    <div class="dropdown-divider"></div>
                    <h6 class="dropdown-header">
                      Admin
                    </h6>
                    <a class="dropdown-item" href="/user/" target="_blank">
                      User Admin App
                    </a>
                  {/if}
                </div>
              </li>
            </ul>
          </div>
        {/if}
      </div>
    </nav>
  {/if}
  {#if $user === null}
    <div class="container mt-3">
      <div class="row">
        <div class="col-md-4 order-md-2 d-flex justify-content-center align-items-start flex-grow-1" ref:loginContainer>
          <TilmeldLogin
            layout="small"
            classInput="form-control w-100"
            classSelect="form-control w-100"
            classTextarea="form-control w-100"
            classSubmit="btn btn-primary w-100"
            classButtonGroup="btn-group d-flex"
            classButton="btn btn-secondary"
            classButtonToggle="flex-grow-1"
            classButtonActive="active"
            disableActiveButton="{false}" />
        </div>
        <div class="col-md-8 order-md-1">
          <FrontPage brand="{brand}" />
        </div>
      </div>
    </div>
  {/if}
  {#if $user}
    <div class="container-fluid d-flex flex-column flex-grow-1 h-100 p-0 m-0">
      {#await $crypt.ready}
        <div class="row d-flex flex-column align-items-center justify-content-center" style="height: 200px;">
          <div class="col-auto">
            <LoadingIndicator width="100px" height="100px" />
          </div>
          <h3>Setting up encryption...</h3>
        </div>
      {:then data}
        <App />
      {:catch error}
        <div>
          Error during encryption setup: {error}
        </div>
      {/await}
    </div>
  {/if}
</div>
{#if $user}
  <div class="modal fade" id="accountInfoModal" tabindex="-1" role="dialog" aria-labelledby="accountInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="accountInfoModalLabel">Account info</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="accountDetailsUsername">Username</label>
            <input type="email" class="form-control" id="accountDetailsUsername" bind:value="$user.data.username" placeholder="Enter username">
          </div>
          <div class="form-group">
            <label for="accountDetailsFirstName">First name</label>
            <input type="text" class="form-control" id="accountDetailsFirstName" bind:value="$user.data.nameFirst" placeholder="Enter name">
          </div>
          <div class="form-group">
            <label for="accountDetailsLastName">Last name</label>
            <input type="text" class="form-control" id="accountDetailsLastName" bind:value="$user.data.nameLast" placeholder="Enter name">
          </div>
          <div class="form-group">
            <label for="accountDetailsPhone">Phone</label>
            <input type="tel" class="form-control" id="accountDetailsPhone" bind:value="$user.data.phone" placeholder="Enter phone number">
          </div>
          {#if clientConfig.timezones}
            <div class="form-group">
              <label for="accountDetailsTimezone">Timezone</label>
              <select class="form-control" id="accountDetailsTimezone" bind:value="$user.data.timezone">
                <option value="">--Default--</option>
                {#each clientConfig.timezones as tz}
                  <option value="{tz}">{tz}</option>
                {/each}
              </select>
            </div>
          {/if}
          <div class="form-group">
            <span>Password</span>
            <TilmeldChangePassword
              layout="compact"
              classInput="form-control"
              classSubmit="btn btn-primary"
              classButton="btn btn-secondary" />
          </div>
          <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="experimentsButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Experiments
            </button>
            <div class="dropdown-menu" aria-labelledby="experimentsButton">
              <!-- <a class="dropdown-item" href="javascript:void(0)" on:click="setExperiment('EXPERIMENT_WEB_PUSH', !EXPERIMENT_WEB_PUSH)"><input type="checkbox" checked="{EXPERIMENT_WEB_PUSH}" /> Web Push Notifications</a> -->
              <span class="dropdown-item">No experiments right now.</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-dismiss="modal" on:click="saveUser()">Save changes</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
{/if}

<script>
  import {User, TilmeldLogin, TilmeldChangePassword} from 'tilmeld-client';
  import $ from 'jquery';
  import LoadingIndicator from './App/LoadingIndicator.html';
  import NavBar from './App/NavBar.html';
  import FrontPage from './App/FrontPage.html';
  import App from './App/App.html';
  import getCookieValue from './Services/getCookieValue';
  import ErrHandler from './ErrHandler';


  // From https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API/Using_the_Web_Storage_API
  const storageAvailable = (type) => {
    try {
      var storage = window[type];
      var x = '__storage_test__';
      storage.setItem(x, x);
      storage.removeItem(x);
      return true;
    } catch(e) {
      return e instanceof DOMException && (
        // everything except Firefox
        e.code === 22 ||
        // Firefox
        e.code === 1014 ||
        // test name field too, because code might not be present
        // everything except Firefox
        e.name === 'QuotaExceededError' ||
        // Firefox
        e.name === 'NS_ERROR_DOM_QUOTA_REACHED') &&
        // acknowledge QuotaExceededError only if there's something already stored
        storage.length !== 0;
    }
  };

  const cryptoAvailable = () => {
    return !!((window.crypto || window.msCrypto).getRandomValues);
  };

  export default {
    actions: {
      tooltip: node => $(node).tooltip()
    },

    oncreate () {
      // Get the client config (for timezones).
      User.getClientConfig().then(clientConfig => {
        this.set({clientConfig});
      });
    },

    onupdate () {
      this.updateNavbarHeight();
    },

    computed: {
      name: ({$conversation, $user}) => $user ? $conversation.getName($user) : ''
    },

    data () {
      return {
        _storageAvailable: storageAvailable('localStorage'),
        _cryptoAvailable: cryptoAvailable(),
        _navbarHeight: 0,
        clientConfig: {}
        // EXPERIMENT_WEB_PUSH: getCookieValue('EXPERIMENT_WEB_PUSH') === 'true'
      };
    },

    methods: {
      saveUser () {
        this.store.get().user.save().then(user => {
          this.store.set({user});
        }, ErrHandler);
      },

      updateNavbarHeightLots () {
        // Damn you, Bootstrap.
        let countdown = 34;
        const interval = window.setInterval(() => {
          this.updateNavbarHeight();
          countdown--;
          if (countdown <= 0) {
            window.clearInterval(interval);
          }
        }, 10);
      },

      updateNavbarHeight () {
        let _navbarHeight = 0;
        if (this.refs.navbar) {
          _navbarHeight = this.refs.navbar.getBoundingClientRect().height;
        }
        if (_navbarHeight !== this.get()._navbarHeight) {
          this.set({_navbarHeight});
        }
      },

      handleConvoClick () {
        const {convosOut} = this.store.get();
        if (convosOut) {
          window.history.back();
        } else {
          this.store.navigate('/pwa-home');
        }
      },

      setExperiment (name, value) {
        document.cookie = `${name}=${value ? 'true' : ''}`;
        this.set({[name]: value});
      }
    },

    components: {
      LoadingIndicator,
      FrontPage,
      TilmeldLogin,
      TilmeldChangePassword,
      NavBar,
      App
    }
  };
</script>

<style>
  ref:loginContainer :global(.login-dialog-container, .login-dialog) {
    width: 100%;
  }
</style>
