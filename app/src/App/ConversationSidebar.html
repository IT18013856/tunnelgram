<div class="d-flex w-100 justify-content-between align-items-center">
  <h5 class="mb-0">{name}</h5>
  <small title="{moment.unix(conversation.mdate).format('llll')}">{modifiedDate}</small>
</div>
{#if conversation.data.lastMessage}
  <small class="mt-1" ref:lastmessage>{conversation.data.lastMessage.decrypted.text}</small>
{/if}

<script>
  import Conversation from '../Entities/Conversation';
  import ErrHandler from '../ErrHandler';
  import moment from 'moment';

  export default {
    oncreate () {
      const updateTime = () => this.set({modifiedDate: moment(new Date(Math.min(this.get().conversation.mdate * 1000, new Date()))).fromNow(true)});
      this.interval = window.setInterval(updateTime, 10000);
      updateTime();
    },

    onstate ({changed, current}) {
      if (!changed.conversation || !current.conversation) {
        return;
      }
      const {conversation} = current;
      if (conversation.data.user.isASleepingReference) {
        conversation.readyAll(() => this.set({conversation}), ErrHandler, 1);
      }
    },

		ondestroy() {
			clearInterval(this.interval);
		},

    data () {
      return {
        conversation: new Conversation()
      }
    },

    computed: {
      name: ({conversation, $user}) => conversation.getName($user),
      isOwner: ({conversation, $user}) => $user.is(conversation.data.user)
    },

    methods: {
      save () {
        this.get().conversation.save().then(() => {}, ErrHandler);
      }
    },

    helpers: {
      moment
    }
  };
</script>

<style>
  ref:lastmessage {
    max-width: 100%;
    display: inline-block;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
</style>
