<div class="h-100 w-100" style="overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain;">
  <div class="d-flex flex-column align-items-center p-3">
    <div class="d-flex justify-content-center flex-wrap w-100">
      <div class="d-inline-block position-relative m-3" on:mouseenter={() => _mouseOverAvatar = true} on:mouseleave={() => _mouseOverAvatar = false}>
        {#if $viewUserIsSelf}
          <input class="d-none" type="file" bind:this={avatarInput} on:change={event => handleAvatar(event.target.files)} />
          <button class="position-absolute btn btn-primary btn-sm rounded" on:click={() => avatarInput.click()} style="right: 0; bottom: 0;">
            <i class="fas fa-upload fa-2x"></i>
          </button>
        {/if}
        {#if _avatarLoading}
          <div class="d-flex position-absolute h-100 w-100 justify-content-center align-items-center">
            <LoadingIndicator width="160" height="160" />
          </div>
        {/if}
        <Avatar bind:user={$viewUser} size="160" />
      </div>
      <div class="m-3"><canvas bind:this={code}></canvas></div>
    </div>
    <h2>{$viewUser.data.name}</h2>
    <div>{$viewUser.data.username}, member since {new SimpleDateFormatter($viewUser.cdate).format('ymd', 'short')}</div>
    <div><button class="btn btn-link" title="Share" on:click={shareShortLink}>{shortLinkPreview}&nbsp;<i class="fas fa-share"></i></button></div>

    <div class="d-flex flex-column justify-content-start w-std-page">
      {#if !$viewUserIsSelf}
        <div class="form-group">
          <label for="viewUserNickname">Nickname</label>
          <div class="d-flex">
            <input type="text" class="form-control flex-grow-1" id="viewUserNickname" bind:value={nickname} aria-describedby="viewUserNicknameHelp" placeholder="Enter nickname" autocomplete="nickname" />
            <button type="button" class="btn btn-primary ml-2" style="width: 100px;" on:click={saveSettings}>Save</button>
          </div>
          <small id="viewUserNicknameHelp" class="form-text text-muted">Only visible to you.</small>
        </div>
      {/if}

      {#if $viewUserIsSelf}
        <div class="form-group">
          <label for="accountDetailsUsername">Username</label>
          <input type="text" class="form-control" id="accountDetailsUsername" bind:value={$viewUser.data.username} placeholder="Enter username" autocomplete="username" />
        </div>
        <div class="form-group">
          <label for="accountDetailsFirstName">First name</label>
          <input type="text" class="form-control" id="accountDetailsFirstName" bind:value={$viewUser.data.nameFirst} placeholder="Enter name" autocomplete="given-name" />
        </div>
        <div class="form-group">
          <label for="accountDetailsLastName">Last name</label>
          <input type="text" class="form-control" id="accountDetailsLastName" bind:value={$viewUser.data.nameLast} placeholder="Enter name" autocomplete="family-name" />
        </div>
        <div class="form-group">
          <label for="accountDetailsPhone">Phone</label>
          <input type="tel" class="form-control" id="accountDetailsPhone" bind:value={$viewUser.data.phone} placeholder="Enter phone number" autocomplete="tel" />
        </div>
        <div class="form-group">
          <span>Password</span>
          <ChangePassword
            layout="compact"
            classInput="form-control"
            classSubmit="btn btn-primary"
            classButton="btn btn-secondary"
          />
        </div>
        <div class="dropdown" bind:this={experimentsDropdown}>
          <button class="btn btn-secondary dropdown-toggle" type="button" id="experimentsButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Experiments
          </button>
          <div class="dropdown-menu" aria-labelledby="experimentsButton">
            <!-- <a class="dropdown-item" href="javascript:void(0)" on:click={() => setExperiment('EXPERIMENT_WEB_PUSH', EXPERIMENT_WEB_PUSH = !EXPERIMENT_WEB_PUSH)}><input type="checkbox" checked={EXPERIMENT_WEB_PUSH} /> Web Push Notifications</a> -->
            <span class="dropdown-item">No experiments right now.</span>
          </div>
        </div>

        <div class="mt-3">
          <button type="button" class="btn btn-primary w-100" on:click={saveUser}>Save changes</button>
        </div>
      {:else}
        <div>
          {#await existingConversations}
            <div>
              One second...
            </div>
          {:then conversations}
            {#if conversations.length}
              <h3 class="mt-3">Your Conversations</h3>
              <div class="list-group mt-3 text-body">
                {#each conversations as conversation (conversation.guid)}
                  <a class="list-group-item list-group-item-action" href="javascript:void(0)" on:click={() => navigate('/c/'+conversation.guid)}>
                    <ConversationPreview bind:conversation={conversation} />
                  </a>
                {/each}
              </div>
              <h3 class="mt-3">Or Start a New One</h3>
            {/if}
            <button type="button" class="btn {conversations.length ? 'btn-light' : 'btn-primary'} mt-3 w-100" on:click={newConversation} disabled={_startingConversation}>Start a Conversation with {$viewUser.data.nameFirst}</button>
          {:catch e}
            <div class="alert alert-danger my-3" role="alert">
              Oops... something went wrong.
            </div>
            <button type="button" class="btn btn-light mt-3 w-100" on:click={newConversation} disabled={_startingConversation}>Start a Conversation with {$viewUser.data.nameFirst}</button>
          {/await}
        </div>
      {/if}
    </div>
  </div>
</div>

<script>
  import {onMount} from 'svelte';
  import {Nymph} from 'nymph-client';
  import ChangePassword from 'tilmeld-components/src/ChangePassword';
  import QRCode from 'qrcode';
  import PNotify from 'pnotify/dist/es/PNotify';
  import Conversation from '../../Entities/Tunnelgram/Conversation';
  import Avatar from './Avatar';
  import ConversationPreview from '../Conversations/ConversationPreview';
  import LoadingIndicator from '../LoadingIndicator';
  import {navigate} from '../../Services/router';
  import {Dropdown} from '../../Services/Val/BSN';
  import {EditImageService} from '../../Services/EditImageService';
  import {getCookieValue} from '../../Services/getCookieValue';
  import {SimpleDateFormatter} from '../../Services/SimpleDateFormatter';
  import ErrHandler from '../../ErrHandler';
  import {
    viewUserIsSelf,
    viewUser,
    user,
    settings,
    conversation,
    conversations,
    brand
  } from '../../stores';

  let nickname = '';
  let code;
  let _startingConversation = false;
  let _mouseOverAvatar = false;
  let _avatarLoading = false;
  let avatarInput;
  // let EXPERIMENT_WEB_PUSH = getCookieValue('EXPERIMENT_WEB_PUSH') === 'true';

  $: shortLink = 'http://tngm.me/'+encodeURIComponent($viewUser.data.username);
  $: shortLinkPreview = 'tngm.me/'+encodeURIComponent($viewUser.data.username);
  $: existingConversations = (() => {
    if ($viewUserIsSelf) {
      return null;
    }

    return Nymph.getEntities({
      'class': Conversation.class,
      'sort': 'mdate',
      'reverse': true
    }, {
      'type': '&',
      'ref': [
        ['acFull', $viewUser.guid],
        ['acFull', $user.guid]
      ]
    }).then(async conversations => {
      await Promise.all(conversations.map(conversation => conversation.readyAll(1).catch(ErrHandler)));
      return conversations;
    });
  })();
  $: {
    if ($settings && $viewUser && $viewUser.guid in $settings.decrypted.nicknames) {
      nickname = $settings.decrypted.nicknames[$viewUser.guid];
    }
  }

  let experimentsDropdown;
  let experimentsDropdownComponent;
  $: {
    if (experimentsDropdown && !experimentsDropdownComponent) {
      experimentsDropdownComponent = new Dropdown(experimentsDropdown);
    } else if (!experimentsDropdown && experimentsDropdownComponent) {
      experimentsDropdownComponent = null;
    }
  }

  onMount(() => {
    QRCode.toCanvas(
      code,
      shortLink,
      {
        errorCorrectionLevel: 'M',
        margin: 1,
        scale: 6,
        color: {
          dark: '#031926',
          light: '#F7F9F9'
        }
      },
      error => {
        if (error) console.error(error);
      }
    );
  });

  function saveUser () {
    $viewUser.save().then(user => {
      $user = user;
      $viewUser = user;
    }, ErrHandler);
  }

  function saveSettings () {
    if ($settings && $viewUser) {
      if (nickname.match(/^\s*$/)) {
        delete $settings.decrypted.nicknames[$viewUser.guid];
      } else {
        $settings.decrypted.nicknames[$viewUser.guid] = nickname;
      }
      $settings.save().then(settings => {
        $settings = settings;
        $viewUser = $viewUser;
        $conversation = $conversation;
        $conversations = $conversations
        $user = $user;
      }, ErrHandler);
    }
  }

  function shareShortLink () {
    const baseText = 'Message ' + ($viewUserIsSelf ? 'me' : $viewUser.data.name) + ' on ' + $brand;
    if (navigator.share !== undefined) {
      navigator.share({
        text: baseText,
        url: shortLink
      })
    } else {
      const ta = document.createElement('textarea');
      ta.value = baseText + ' at ' + shortLink;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      PNotify.info({
        text: 'Copied to Clipboard'
      });
    }
  }

  function newConversation () {
    const conversation = new Conversation();
    conversation.data.acFull.push($viewUser);

    _startingConversation = true;
    conversation.save().then(() => navigate('/c/'+conversation.guid), ErrHandler).finally(() => {
      _startingConversation = false;
    });
  }

  function setExperiment (name, value) {
    document.cookie = `${name}=${value ? 'true' : ''}`;
  }

  async function handleAvatar (files) {
    const file = files[0];

    if (!file.type.startsWith('image/')) {
      PNotify.notice({
        title: 'Only Image',
        text: 'What are you doing? You can only use an image as an avatar.'
      });
      return;
    }

    _avatarLoading = true;

    // Read the image into an Image to resize it and generate a thumbnail.
    const image = new Image();
    const tempObjectURL = URL.createObjectURL(file);
    let resolve;
    const p = new Promise(r => resolve = r);
    image.onload = () => resolve();
    image.src = tempObjectURL;
    await p;

    let resizeImage = new EditImageService(image, file.type);
    const avatarImg = await resizeImage.resizeCrop(500, 500);
    resizeImage.destroy();

    avatar = avatarImg.data;

    $viewUser = $viewUser;
    _avatarLoading = false;
  }
</script>
