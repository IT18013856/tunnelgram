<div class="h-100 w-100" style="overflow-y: auto; overscroll-behavior: contain;">
  <div class="d-flex flex-column align-items-center py-3">
    <div class="d-inline-block position-relative mb-3" on:mouseenter="set({_mouseOverAvatar: true})" on:mouseleave="set({_mouseOverAvatar: false})">
      {#if $viewUserIsSelf}
        <input class="d-none" type="file" ref:avatarInput on:change="handleAvatar(event.target.files)" capture />
        <a class="{_mouseOverAvatar ? 'd-flex' : 'd-none'} position-absolute h-100 w-100 justify-content-center align-items-center" href="javascript:void(0)" on:click="refs.avatarInput.click()">
          <i class="fas fa-upload fa-3x"></i>
        </a>
      {/if}
      {#if _avatarLoading}
        <div class="d-flex position-absolute h-100 w-100 justify-content-center align-items-center">
          <LoadingIndicator width="160px" height="160px" />
        </div>
      {/if}
      <Avatar user="{$viewUser}" size="160" />
    </div>
    <h2>{$viewUser.data.name}</h2>
    <div>{$viewUser.data.username}, member since {moment.unix($viewUser.cdate).format('MMM D, YYYY')}</div>

    {#if !$viewUserIsSelf}
      <div class="d-flex flex-column justify-content-start w-100 px-2" style="max-width: 600px;">
        <div class="form-group">
          <label for="viewUserNickname">Nickname</label>
          <div class="d-flex">
            <input type="text" class="form-control flex-grow-1" id="viewUserNickname" bind:value="nickname" aria-describedby="viewUserNicknameHelp" placeholder="Enter nickname" autocomplete="nickname" />
            <button type="button" class="btn btn-primary ml-2" style="width: 100px;" on:click="saveSettings()">Save</button>
          </div>
          <small id="viewUserNicknameHelp" class="form-text text-muted">Only visible to you.</small>
        </div>
      </div>
    {/if}

    <h3 class="mt-3">{$viewUserIsSelf ? 'Your' : $viewUser.data.nameFirst+'\'s'} Short-Link</h3>
    <div class="text-center">
      <button class="btn btn-link" title="Share" on:click="shareShortLink()">{shortLinkPreview}&nbsp;<i class="fas fa-share"></i></button>
      <br />
      <canvas ref:code></canvas>
    </div>

    {#if $viewUserIsSelf}
      <div class="d-flex flex-column justify-content-start w-100 px-2" style="max-width: 600px;">
        <div class="form-group">
          <label for="accountDetailsUsername">Username</label>
          <input type="text" class="form-control" id="accountDetailsUsername" bind:value="$viewUser.data.username" placeholder="Enter username" autocomplete="username" />
        </div>
        <div class="form-group">
          <label for="accountDetailsFirstName">First name</label>
          <input type="text" class="form-control" id="accountDetailsFirstName" bind:value="$viewUser.data.nameFirst" placeholder="Enter name" autocomplete="given-name" />
        </div>
        <div class="form-group">
          <label for="accountDetailsLastName">Last name</label>
          <input type="text" class="form-control" id="accountDetailsLastName" bind:value="$viewUser.data.nameLast" placeholder="Enter name" autocomplete="family-name" />
        </div>
        <div class="form-group">
          <label for="accountDetailsPhone">Phone</label>
          <input type="tel" class="form-control" id="accountDetailsPhone" bind:value="$viewUser.data.phone" placeholder="Enter phone number" autocomplete="tel" />
        </div>
        <div class="form-group">
          <span>Password</span>
          <TilmeldChangePassword
            layout="compact"
            classInput="form-control"
            classSubmit="btn btn-primary"
            classButton="btn btn-secondary" />
        </div>
        <div class="dropdown" ref:experimentsDropdown>
          <button class="btn btn-secondary dropdown-toggle" type="button" id="experimentsButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Experiments
          </button>
          <div class="dropdown-menu" aria-labelledby="experimentsButton">
            <!-- <a class="dropdown-item" href="javascript:void(0)" on:click="setExperiment('EXPERIMENT_WEB_PUSH', !EXPERIMENT_WEB_PUSH)"><input type="checkbox" checked="{EXPERIMENT_WEB_PUSH}" /> Web Push Notifications</a> -->
            <span class="dropdown-item">No experiments right now.</span>
          </div>
        </div>

        <div class="mt-3">
          <button type="button" class="btn btn-primary w-100" on:click="saveUser()">Save changes</button>
        </div>
      </div>
    {:else}
      <h3 class="mt-3">Your Conversations</h3>
      <div class="d-flex flex-column align-items-center w-100">
        {#await existingConversations}
          <div>
            One second...
          </div>
        {:then conversations}
          {#if !conversations.length}
            <div>
              You've got no conversations with {$viewUser.data.nameFirst}.
            </div>
          {:else}
            <div class="list-group mt-3 text-body w-100 px-2" style="max-width: 600px;">
              {#each conversations as conversation (conversation.guid)}
                <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" href="javascript:void(0)" on:click="$navigate('/c/'+conversation.guid)">
                  <h5 class="mb-0">{conversation.getName($settings)}</h5>
                  <small class="ml-1" title="{moment.unix(conversation.mdate).format('llll')}" style="white-space: nowrap;">{moment.unix(conversation.mdate).fromNow(true)}</small>
                </a>
              {/each}
            </div>
          {/if}
        {:catch e}
          <div>
            Oops... something went wrong.
          </div>
        {/await}
      </div>
      <button type="button" class="btn btn-primary mt-3" on:click="newConversation()" disabled="{_startingConversation}">Start a New Conversation with {$viewUser.data.nameFirst}</button>
    {/if}
  </div>
</div>

<script>
  import {Nymph} from 'nymph-client';
  import {TilmeldChangePassword} from 'tilmeld-client';
  import bsn from 'bootstrap.native/dist/bootstrap-native-v4';
  import moment from 'moment';
  import QRCode from 'qrcode';
  import PNotify from 'pnotify/dist/es/PNotify';
  import Conversation from '../../Entities/Conversation';
  import Avatar from './Avatar.html';
  import LoadingIndicator from '../LoadingIndicator.html';
  import EditImage from '../../Services/EditImage';
  import getCookieValue from '../../Services/getCookieValue';
  import ErrHandler from '../../ErrHandler';

  export default {
    oncreate () {
      QRCode.toCanvas(
        this.refs.code,
        this.get().shortLink,
        {
          errorCorrectionLevel: 'M',
          margin: 1,
          scale: 6,
          color: {
            dark: '#211526',
            light: '#F5F5F2'
          }
        },
        error => {
          if (error) console.error(error);
        }
      );

      this.storeStateListener = this.store.on('state', ({changed, current, previous}) => {
        if ((changed.settings || changed.viewUser) && current.settings && current.viewUser) {
          this.set({nickname: current.settings.decrypted.nicknames[current.viewUser.guid]});
        }
      });
      const {settings, viewUser} = this.store.get();
      if (settings && viewUser && viewUser.guid in settings.decrypted.nicknames) {
        this.set({nickname: settings.decrypted.nicknames[viewUser.guid]});
      }
    },

    onupdate () {
      if (this.refs.experimentsDropdown && !this.experimentsDropdown) {
        this.experimentsDropdown = new bsn.Dropdown(this.refs.experimentsDropdown);
      } else if (!this.refs.experimentsDropdown && this.experimentsDropdown) {
        delete this.experimentsDropdown;
      }
    },

    ondestroy () {
      this.storeStateListener.cancel();
    },

    computed: {
      shortLink: ({$viewUser}) => 'http://tngm.me/'+encodeURIComponent($viewUser.data.username),
      shortLinkPreview: ({$viewUser}) => 'tngm.me/'+encodeURIComponent($viewUser.data.username),
      existingConversations: ({$viewUser, $viewUserIsSelf, $user}) => {
        if ($viewUserIsSelf) {
          return null;
        }

        return Nymph.getEntities({
          'class': Conversation.class,
          'sort': 'mdate',
          'reverse': true
        }, {
          'type': '&',
          'ref': [
            ['acFull', $viewUser.guid],
            ['acFull', $user.guid]
          ]
        }).then(async conversations => {
          await Promise.all(conversations.map(conversation => conversation.readyAll(undefined, ErrHandler, 1)));
          return conversations;
        });
      }
    },

    data () {
      return {
        _startingConversation: false,
        _mouseOverAvatar: false,
        _avatarLoading: false,
        nickname: '',
        // EXPERIMENT_WEB_PUSH: getCookieValue('EXPERIMENT_WEB_PUSH') === 'true'
      };
    },

    methods: {
      saveUser () {
        this.store.get().viewUser.save().then(user => {
          this.store.set({user, viewUser: user});
        }, ErrHandler);
      },

      saveSettings () {
        const {settings, viewUser} = this.store.get();
        if (settings && viewUser) {
          const {nickname} = this.get();
          if (nickname.match(/^\s*$/)) {
            delete settings.decrypted.nicknames[viewUser.guid];
          } else {
            settings.decrypted.nicknames[viewUser.guid] = nickname;
          }
          settings.save().then(settings => {
            const {conversation, conversations, user} = this.store.get();
            this.store.set({settings, viewUser, conversation, conversations, user});
          }, ErrHandler);
        }
      },

      shareShortLink () {
        if (navigator.share !== undefined) {
          navigator.share({
            text: 'Message me on Tunnelgram',
            url: this.get().shortLink
          })
        } else {
          const ta = document.createElement('textarea');
          ta.value = 'Message me on Tunnelgram at '+this.get().shortLink;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          PNotify.info({
            text: 'Copied to Clipboard'
          });
        }
      },

      newConversation () {
        const {viewUser} = this.store.get();
        const conversation = new Conversation();
        conversation.data.acFull.push(viewUser);

        this.set({_startingConversation: true});
        conversation.save().then(() => this.store.navigate('/c/'+conversation.guid), ErrHandler).finally(() => {
          this.set({_startingConversation: false});
        });
      },

      setExperiment (name, value) {
        document.cookie = `${name}=${value ? 'true' : ''}`;
        this.set({[name]: value});
      },

      async handleAvatar (files) {
        const file = files[0];

        if (!file.type.startsWith('image/')) {
          PNotify.notice({
            title: 'Only Image',
            text: 'What are you doing? You can only use an image as an avatar.'
          });
          return;
        }

        this.set({_avatarLoading: true});

        // Read the image into an Image to resize it and generate a thumbnail.
        const image = new Image();
        const tempObjectURL = URL.createObjectURL(file);
        let resolve;
        const p = new Promise(r => resolve = r);
        image.onload = () => resolve();
        image.src = tempObjectURL;
        await p;

        let resizeImage = new EditImage(image, file.type);
        const avatarImg = await resizeImage.resizeCrop(500, 500);
        resizeImage.destroy();

        const {viewUser} = this.store.get();
        viewUser.set({avatar: avatarImg.data});

        this.store.set({viewUser});
        this.set({_avatarLoading: false});
      }
    },

    components: {
      LoadingIndicator,
      TilmeldChangePassword,
      Avatar
    },

    helpers: {
      moment
    }
  }
</script>
