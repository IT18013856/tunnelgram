{#if $disconnected}
  <div class="alert alert-warning d-flex justify-content-center align-items-center m-0">
    Waiting for network...
    <span class="network-waiting-container">
      <span class="network-waiting">
        <i class="fas fa-wifi"></i>
      </span>
    </span>
  </div>
{/if}
{#if $beforeInstallPromptEvent && !_hideInstallPrompt}
  <div class="alert alert-info d-flex justify-content-between align-items-center m-0">
    <div>
      Wanna install Tunnelgram.com to your app drawer for an app-like experience?
      <a href="javascript:void(0)" on:click="set({_hideInstallPrompt: true, _nothing: $beforeInstallPromptEvent.prompt()})">Yeah</a>
    </div>

    <a class="ml-2" href="javascript:void(0)" on:click="set({_hideInstallPrompt: true})">
      <i class="fas fa-times"></i>
    </a>
  </div>
{:elseif !_hideNotificationPrompt}
  <div class="alert alert-info d-flex justify-content-between align-items-center m-0">
    <div>
      Do you want to get notifications for new messages?
      <a href="javascript:void(0)" on:click="set({_hideNotificationPrompt: true, _nothing: $requestNotificationPermission.call()})">Yeah</a>
    </div>

    <a class="ml-2" href="javascript:void(0)" on:click="set({_hideNotificationPrompt: true})">
      <i class="fas fa-times"></i>
    </a>
  </div>
{:elseif !_hidePersistentStoragePrompt}
  <div class="alert alert-info d-flex justify-content-between align-items-center m-0">
    <div>
      Do you want to stay logged in when your device runs low on space?
      <a href="javascript:void(0)" on:click="set({_hidePersistentStoragePrompt: true, _nothing: $requestPersistentStorage()})">Yeah</a>
    </div>

    <a class="ml-2" href="javascript:void(0)" on:click="set({_hidePersistentStoragePrompt: true})">
      <i class="fas fa-times"></i>
    </a>
  </div>
{/if}
<div class="d-flex flex-small-row flex-grow-1 h-100 position-relative">
  <div class="w-100 bg-dark text-light d-lg-block {$convosOut ? '' : 'd-none'}" ref:convos>
    <ConversationList
      on:tunnelgram-notification="notification(event.update)"
      on:tunnelgram-navigate="navigate(event.conversation)" />
  </div>
  <div class="flex-grow-1 d-lg-block {!$convosOut ? '' : 'd-none'}">
    {#if $loadingConversation || $loadingUser}
      <div class="d-flex align-items-center justify-content-center" style="height: 200px;">
        <div class="col-auto">
          <LoadingIndicator width="50px" height="50px" />
        </div>
      </div>
    {:elseif $view === 'user'}
      <UserView />
    {:else}
      <ConversationContainer />
    {/if}
  </div>
</div>

<script>
  import PNotify from 'pnotify/dist/es/PNotify';
  import 'pnotify/dist/es/PNotifyDesktop';
  import Conversation from '../Entities/Tunnelgram/Conversation';
  import LoadingIndicator from './LoadingIndicator.html';
  import ConversationList from './Conversations/ConversationList.html';
  import ConversationContainer from './Conversations/ConversationContainer.html';
  import UserView from './Users/UserView.html';
  import {getCookieValue} from '../Services/getCookieValue';
  import ErrHandler from '../ErrHandler';

  const _hideNotificationPrompt = !('Notification' in window) || Notification.permission !== 'default';

  export default {
    oncreate () {
      (async () => {
        if (navigator.storage && navigator.storage.persist) {
          this.set({_hidePersistentStoragePrompt: await navigator.storage.persisted()});
        }
      })();
    },

    data () {
      return {
        _hideInstallPrompt: false,
        _hideNotificationPrompt,
        _hidePersistentStoragePrompt: true
      };
    },

    methods: {
      navigate (conversation) {
        if (this.store.get().router.lastRouteResolved().url !== '/c/'+conversation.guid) {
          this.store.navigate('/c/'+conversation.guid);
        } else {
          this.store.set({convosOut: false});
        }
      },

      async notification (update) {
        // Calculate whether the page is hidden.
        let hidden = 'hasFocus' in document ? !document.hasFocus() : document.hidden;

        if (hidden && this.store.get().webPushSubscription) {
          // They will get a push notification.
          return;
        }

        if (update.deleted || !update.data) {
          return;
        }

        const conversation = new Conversation();
        conversation.init(update.data);

        if (conversation.data.lastMessage) {
          if (conversation.is(this.store.get().conversation) && !hidden) {
            // Don't notify if the user is on the conversation and not hidden.
            return;
          }
          await conversation.data.lastMessage.ready();
          if (this.store.get().user.is(conversation.data.lastMessage.data.user)) {
            // Don't notify if the user made the message.
            return;
          }
          if (conversation.readline >= conversation.data.lastMessage.cdate) {
            // Don't notify when a user deletes a message (will result in earlier message becoming lastMessage).
            return;
          }
          await conversation.data.lastMessage.data.user.ready();
        } else if (update.added) {
          if (this.store.get().user.is(conversation.data.user)) {
            // Don't notify if the user made a new conversation.
            return;
          }
          await conversation.readyAll(undefined, ErrHandler, 1);
        } else {
          return;
        }

        let notice;
        let options = {};
        if (hidden) {
          // If the tab is hidden, display a desktop notice.
          Object.assign(options, {
            modules: {
              Desktop: {
                desktop: Notification.permission === 'granted',
                icon: false
              }
            }
          });
        }
        if (conversation.data.lastMessage) {
          // Notify the user of a new message.
          notice = PNotify.info(Object.assign({
            title: this.store.getDisplayName(conversation.data.lastMessage.data.user, 'name')
              + (conversation.data.acFull.length > 2 || conversation.data.name != null
                ? ' - ' + conversation.getName(this.store.get().settings)
                : ''
              )
              + ' - Tunnelgram',
            text:  conversation.data.lastMessage.decrypted.text.length > 40
              ? conversation.data.lastMessage.decrypted.text.substr(0, 40) + '...'
              : conversation.data.lastMessage.decrypted.text
          }, options));
        } else if (update.added) {
          // Notify the user of a new conversation.
          notice = PNotify.info(Object.assign({
            title: 'New Conversation - Tunnelgram',
            text: this.store.getDisplayName(conversation.data.user, 'name') + ' started '
              + (conversation.data.acFull.length > 2 || conversation.data.name != null
                ? conversation.getName(this.store.get().settings)
                : 'a conversation'
              )
              + '.'
          }, options));
        }

        notice.on('click', e => {
          let target = e.target;
          while (target.parentNode) {
            if (target.classList && target.classList.contains('ui-pnotify-closer')) {
              return;
            }
            target = target.parentNode;
          }
          if (hidden) {
            window.focus();
          }
          if (!conversation.is(this.store.get().conversation)) {
            window.requestAnimationFrame(() => {
              this.navigate(conversation);
            });
          }
          notice.close();
        });
      }
    },

    components: {
      LoadingIndicator,
      ConversationList,
      ConversationContainer,
      UserView
    }
  };
</script>

<style>
  @media (min-width: 991.98px) {
    ref:convos {
      max-width: 350px;
    }
  }

  .network-waiting-container {
    display: inline-block;
    width: auto;
    height: 100%;
    margin: 0 0 0 10px;
    perspective: 1000;
    backface-visibility: hidden;
    background: transparent;
  }

  .network-waiting {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1em;
    text-align: center;
    height: 1.5em;
    width: 1.5em;
    color: white;
    border: none;
    border-radius: 50%;
    background: #91B5AA;
    box-shadow: 0 0 0 0 rgba(#91B5AA, .5);
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0% {
      transform: scale(.9);
    }
    70% {
      transform: scale(1);
      box-shadow: 0 0 0 30px rgba(#91B5AA, 0);
    }
    100% {
      transform: scale(.9);
      box-shadow: 0 0 0 0 rgba(#91B5AA, 0);
    }
  }
</style>
