{#if _loading}
  <div class="d-flex align-items-center justify-content-center" style="height: 200px;">
    <div class="col-auto">
      <LoadingIndicator width="50px" height="50px" />
    </div>
  </div>
{:else}
  <div class="d-flex flex-small-row flex-grow-1">
    <div class="w-100 mh-100 bg-dark text-light d-lg-block {$convosOut ? '' : 'd-none'}" style="overflow-y: auto;" ref:convos>
      <div class="list-group">
        <a class="list-group-item list-group-item-action {$conversation.guid == null ? 'active' : ''}" href="javascript:void(0)" on:click="newConversation()">
          <div class="d-flex w-100 align-items-center">
            <h5 class="mb-0"><i class="fas fa-plus-circle"></i> New Conversation</h5>
          </div>
        </a>
        {#if $conversations.length}
          {#each $conversations as conversation (conversation.guid)}
            <a class="list-group-item list-group-item-action flex-column align-items-start {conversation.guid === $conversation.guid ? 'active' : ''}" href="javascript:void(0)" on:click="openConversation(conversation)">
              <ConversationSidebar bind:conversation />
            </a>
          {/each}
        {:else}
          <div class="list-group-item flex-column align-items-start bg-transparent border-0">
            You have no conversations yet.
          </div>
        {/if}
      </div>
      {#if $conversations.length > 1}
        <div>
          Sort: <br>
          <label class="font-weight-normal">
            <input type="radio" bind:group="$sort" on:change="sortConversations()" name="sort" value="name"> Alphabetical</label>
          &nbsp;&nbsp;&nbsp;
          <label class="font-weight-normal">
            <input type="radio" bind:group="$sort" on:change="sortConversations()" name="sort" value="mdate"> Newest</label>
        </div>
      {/if}
    </div>
    <div class="flex-grow-1 d-lg-block {!$convosOut ? '' : 'd-none'}">
      <ConversationMain />
    </div>
  </div>
{/if}

<script>
  import {Nymph, PubSub} from 'nymph-client';
  import Conversation from '../Entities/Conversation';
  import LoadingIndicator from './LoadingIndicator.html';
  import ConversationSidebar from './ConversationSidebar.html';
  import ConversationMain from './ConversationMain.html';
  import ErrHandler from '../ErrHandler';

  export default {
    oncreate () {
      this.store.on('state', ({changed, current, previous}) => {
        if (changed.archived ||
            (
              changed.user &&
              current.user &&
              !current.user.is(previous.user)
            )
          ) {
          this.subscribe();
        }
      });
      this.subscribe();

      this.newConversation();
    },

    ondestroy () {
      let {_subscription} = this.get();
      if (_subscription) {
        _subscription.unsubscribe();
      }
    },

    data () {
      return {}
    },

    methods: {
      subscribe () {
        let {_subscription} = this.get();
        if (_subscription) {
          _subscription.unsubscribe();
        }

        this.set({_loading: true});

        _subscription = Nymph.getEntities(
            {'class': Conversation.class}
        ).subscribe(update => {
          this.set({_loading: false});
          if (update) {
            const {conversations, sort} = this.store.get();
            PubSub.updateArray(conversations, update);
            Nymph.sort(conversations, sort);
            this.store.set({conversations});
          }
        }, ErrHandler);
        this.set({_subscription});
      },

      sortConversations () {
        const {conversations, sort} = this.store.get();
        this.store.set({conversations: Nymph.sort(conversations, sort)});
      },

      newConversation () {
        const conversation = new Conversation();
        conversation.data.acFull.push(this.store.get().user);
        this.store.set({conversation: conversation, convosOut: false});
      },

      openConversation (conversation) {
        this.set({_loading: true});
        this.store.set({conversation, view: 'conversation', convosOut: false});
        this.set({_loading: false});
      }
    },

    components: {
      LoadingIndicator,
      ConversationSidebar,
      ConversationMain
    }
  };
</script>

<style>
  @media (min-width: 991.98px) {
    ref:convos {
      max-width: 250px;
    }
  }
</style>
