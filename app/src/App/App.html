{#if $disconnected}
  <div class="alert alert-warning d-flex justify-content-center align-items-center m-0">
    Waiting for network...
    <span class="network-waiting-container">
      <span class="network-waiting">
        <i class="fas fa-wifi"></i>
      </span>
    </span>
  </div>
{/if}
{#if $beforeInstallPromptEvent && !_hideInstallPrompt}
  <div class="alert alert-info d-flex justify-content-between align-items-center m-0">
    <div>
      Wanna install {$brandWeb} to your app drawer for an app-like experience?
      <a href="javascript:void(0)" on:click={() => _hideInstallPrompt = true} on:click={() => $beforeInstallPromptEvent.prompt()}>Yeah</a>
    </div>

    <a class="ml-2" href="javascript:void(0)" on:click={() => _hideInstallPrompt = true} title="Close">
      <i class="fas fa-times"></i>
    </a>
  </div>
{:else if !_hideNotificationPrompt}
  <div class="alert alert-info d-flex justify-content-between align-items-center m-0">
    <div>
      Do you want to get notifications for new messages?
      <a href="javascript:void(0)" on:click={() => _hideNotificationPrompt = true} on:click={$requestNotificationPermission}>Yeah</a>
    </div>

    <a class="ml-2" href="javascript:void(0)" on:click={() => _hideNotificationPrompt = true} title="Close">
      <i class="fas fa-times"></i>
    </a>
  </div>
{:else if false && !_hidePersistentStoragePrompt}
  <div class="alert alert-info d-flex justify-content-between align-items-center m-0">
    <div>
      Do you want to stay logged in when your device runs low on space?
      <a href="javascript:void(0)" on:click={() => _hidePersistentStoragePrompt = true} on:click={$requestPersistentStorage}>Yeah</a>
    </div>

    <a class="ml-2" href="javascript:void(0)" on:click={() => _hidePersistentStoragePrompt = true} title="Close">
      <i class="fas fa-times"></i>
    </a>
  </div>
{/if}
<div class="d-flex flex-row flex-grow-1 h-100 position-relative {$convosOut ? 'convos-out' : ''}">
  <div class="convos d-flex flex-column h-100 bg-dark text-light" ref:convos>
    <nav class="navbar navbar-expand navbar-dark bg-dark">
      <div class="container-fluid">
        <span class="navbar-brand align-items-center">
          <span>{$brand}</span>
        </span>
        <ul class="navbar-nav ml-auto">
          <li class="nav-item dropdown" ref:menuDropdown>
            <a class="nav-link dropdown-toggle p-0" href="javascript:void(0)" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <Avatar bind:user="$user" />
            </a>
            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
              <h6 class="dropdown-header">
                {$user.data.name}
              </h6>
              <a class="dropdown-item" href="javascript:void(0)" on:click={() => navigate('/u/' + $user.data.username)}>
                Your Account
              </a>
              <a class="dropdown-item" href="javascript:void(0)" on:click={() => navigate('/pushSubscriptions')}>
                Push Subscriptions
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="javascript:void(0)" on:click={logout}>
                Log Out
              </a>
              {#if $userIsTilmeldAdmin}
                <div class="dropdown-divider"></div>
                <h6 class="dropdown-header">
                  Admin
                </h6>
                <a class="dropdown-item" href="/user/" target="_blank">
                  User Admin App
                </a>
              {/if}
            </div>
          </li>
        </ul>
      </div>
    </nav>
    <div style="overflow-y: hidden; height: 100%; flex-basis: 0; flex-grow: 1;">
      <ConversationList
        on:tunnelgram-notification="notification(event.update)"
        on:tunnelgram-navigate="navigateConversation(event.conversation)" />
    </div>
  </div>
  <!-- This needs the width:0 style, or it will offset the list during loading. -->
  <div class="main-ui flex-grow-1 d-flex flex-column h-100 bg-light text-dark" style="width: 0;" ref:mainUi>
    <nav class="navbar navbar-expand navbar-dark bg-dark">
      <div class="container-fluid">
        <ul class="navbar-nav d-md-none">
          <li class="nav-item">
            <a class="nav-link border-secondary rounded px-2" href="javascript:void(0)" on:click={() => $convosOut = true} title="Back to list">
              <i class="fas fa-arrow-left"></i>
            </a>
          </li>
        </ul>
        <span class="page-name navbar-text">
          <span>{name}&nbsp;</span>
        </span>
        {#if ['conversation', 'people', 'settings'].indexOf($view) !== -1 && $conversation.guid}
          <NavBar />
        {/if}
      </div>
    </nav>
    <div style="overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; height: 100%; flex-basis: 0; flex-grow: 1;">
      {#if $loadingConversation || $loadingUser}
        <div class="d-flex h-100 align-items-center justify-content-center">
          <div style="background-image: url(images/android-chrome-192x192.png); background-size: cover; position: absolute; width: 88px; height: 88px;"></div>
          <LoadingIndicator width="200" height="200" />
        </div>
      {:else if $view === 'user'}
        <UserView />
      {:else if $view === 'pushSubscriptions'}
        <PushSubscriptionsView />
      {:else}
        <ConversationView />
      {/if}
    </div>
  </div>
</div>

<script>
  import PNotify from 'pnotify/dist/es/PNotify';
  import 'pnotify/dist/es/PNotifyDesktop';
  import TinyGesture from 'tinygesture';
  import Conversation from '../Entities/Tunnelgram/Conversation';
  import LoadingIndicator from './LoadingIndicator.html';
  import ConversationList from './Conversations/ConversationList.html';
  import ConversationView from './Conversations/ConversationView.html';
  import NavBar from './NavBar.html';
  import Avatar from './Users/Avatar.html';
  import UserView from './Users/UserView.html';
  import PushSubscriptionsView from './Users/PushSubscriptionsView.html';
  import {router, navigate} from '../Services/router';
  import {getCookieValue} from '../Services/getCookieValue';
  import {getDisplayName} from '../Services/getDisplayName';
  import {Dropdown} from '../Services/Val/BSN';
  import ErrHandler from '../ErrHandler';
  import {
    logout,
    disconnected,
    beforeInstallPromptEvent,
    requestNotificationPermission,
    requestPersistentStorage,
    brandWeb,
    convosOut,
    brand,
    user,
    userIsTilmeldAdmin,
    view,
    conversation,
    loadingConversation,
    loadingUser,
    webPushSubscription,
    settings
  } from '../stores';

  const _hideNotificationPrompt = !('Notification' in window) || Notification.permission !== 'default';

  export default {
    oncreate () {
      if (window.inCordova) {
        window.plugins.OneSignal.userProvidedPrivacyConsent(consent => {
          this.set({_hideNotificationPrompt: consent});
        });
      }

      (async () => {
        if (navigator.storage && navigator.storage.persist) {
          this.set({_hidePersistentStoragePrompt: await navigator.storage.persisted()});
        }
      })();
    },

    onupdate ({previous}) {
      if (this.refs.menuDropdown && !this.menuDropdown) {
        this.menuDropdown = new Dropdown(this.refs.menuDropdown);
      } else if (!this.refs.menuDropdown && this.menuDropdown) {
        delete this.menuDropdown;
      }

      // Set the mainUi width to the proper value.
      this.refs.mainUi.style.width = '100%';
      // Initialize swipe gestures.
      const onPanMove = (gesture, transform) => {
        if (gesture.animationFrame) {
          return;
        }
        gesture.animationFrame = window.requestAnimationFrame(() => {
          if (gesture.swipingDirection === 'horizontal') {
            this.refs.mainUi.style.transition = 'none';
            this.refs.mainUi.style.transform = transform();
            window.requestAnimationFrame(() => {
              this.refs.mainUi.style.transition = null;
            });
          } else if (this.refs.mainUi.style.transform != null) {
            this.refs.mainUi.style.transform = null;
          }
          gesture.animationFrame = null;
        });
      };
      const onPanEnd = gesture => {
        window.cancelAnimationFrame(gesture.animationFrame);
        gesture.animationFrame = null;
        this.refs.mainUi.style.transition = null;
        this.refs.mainUi.style.transform = null;
      };
      if (this.refs.mainUi && !this.mainUiGesture) {
        this.mainUiGesture = new TinyGesture(this.refs.mainUi, {mouseSupport: false});
        this.mainUiGesture.on('swiperight', () => $convosOut = true);
        this.mainUiGesture.on('panmove', onPanMove.bind(
          this,
          this.mainUiGesture,
          () => 'translate3d(calc(-100% + '+Math.max(this.mainUiGesture.touchMoveX, 0)+'px), 0, 0)'
        ));
        this.mainUiGesture.on('panend', onPanEnd.bind(this, this.mainUiGesture));
      } else if (!this.refs.mainUi && this.mainUiGesture) {
        this.mainUiGesture.destroy();
        delete this.mainUiGesture;
      }
      if (this.refs.convos && !this.convosGesture) {
        this.convosGesture = new TinyGesture(this.refs.convos, {mouseSupport: false});
        this.convosGesture.on('swipeleft', () => $convosOut = false);
        this.convosGesture.on('panmove', onPanMove.bind(
          this,
          this.convosGesture,
          () => 'translate3d('+this.convosGesture.touchMoveX+'px, 0, 0)'
        ));
        this.convosGesture.on('panend', onPanEnd.bind(this, this.convosGesture));
      } else if (!this.refs.convos && this.convosGesture) {
        this.convosGesture.destroy();
        delete this.convosGesture;
      }
    },

    computed: {
      name: ({$view, $viewUser, $conversation, $conversations, $settings}) => {
        if ($view === 'pushSubscriptions') {
          return 'Push Subscriptions';
        }
        if ($view === 'user') {
          return $viewUser.data.name;
        }
        if ($settings && $conversation.guid) {
          return $conversation.getName($settings);
        }
        return '';
      }
    },

    data () {
      return {
        _hideInstallPrompt: false,
        _hideNotificationPrompt,
        _hidePersistentStoragePrompt: true
      };
    },

    methods: {
      navigateConversation (conversation) {
        if (router.lastRouteResolved().url !== '/c/'+conversation.guid) {
          navigate('/c/'+conversation.guid);
        } else {
          $convosOut = false;
        }
      },

      async notification (update) {
        if (document.hidden && $webPushSubscription) {
          // They will get a push notification.
          return;
        }

        if (update.deleted || !update.data) {
          return;
        }

        const conversation = new Conversation();
        conversation.init(update.data);

        if (conversation.data.lastMessage) {
          if (conversation.is($conversation) && !document.hidden) {
            // Don't notify if the user is on the conversation and not hidden.
            return;
          }
          await conversation.data.lastMessage.ready();
          if ($user.is(conversation.data.lastMessage.data.user)) {
            // Don't notify if the user made the message.
            return;
          }
          if (conversation.readline >= conversation.data.lastMessage.cdate) {
            // Don't notify when a user deletes a message (will result in earlier message becoming lastMessage).
            return;
          }
          await conversation.data.lastMessage.data.user.ready();
        } else if (update.added) {
          if ($user.is(conversation.data.user)) {
            // Don't notify if the user made a new conversation.
            return;
          }
          await conversation.readyAll(1).catch(ErrHandler);
        } else {
          return;
        }

        let notice;
        let options = {};
        if (document.hidden) {
          // If the tab is hidden, display a desktop notice.
          Object.assign(options, {
            modules: {
              Desktop: {
                desktop: Notification.permission === 'granted',
                icon: false
              }
            }
          });
        }
        if (conversation.data.lastMessage) {
          // Notify the user of a new message.
          notice = PNotify.info(Object.assign({
            title: getDisplayName(conversation.data.lastMessage.data.user, 'name')
              + (conversation.data.acFull.length > 2 || conversation.data.name != null
                ? ' - ' + conversation.getName($settings)
                : ''
              ),
            text:  conversation.data.lastMessage.decrypted.text.length > 40
              ? conversation.data.lastMessage.decrypted.text.substr(0, 40) + '...'
              : conversation.data.lastMessage.decrypted.text
          }, options));
        } else if (update.added) {
          // Notify the user of a new conversation.
          notice = PNotify.info(Object.assign({
            title: 'New Conversation',
            text: getDisplayName(conversation.data.user, 'name') + ' started '
              + (conversation.data.acFull.length > 2 || conversation.data.name != null
                ? conversation.getName($settings)
                : 'a conversation'
              )
              + '.'
          }, options));
        }

        notice.on('click', e => {
          let target = e.target;
          while (target.parentNode) {
            if (target.classList && target.classList.contains('ui-pnotify-closer')) {
              return;
            }
            target = target.parentNode;
          }
          if (document.hidden) {
            window.focus();
          }
          if (!conversation.is($conversation)) {
            window.requestAnimationFrame(() => {
              this.navigateConversation(conversation);
            });
          }
          notice.close();
        });
      }
    }
  };
</script>

<style>
  .convos {
    width: 100%;
  }
  .main-ui {
    position: absolute;
    left: 100%;
    top: 0;
    bottom: 0;
    z-index: 2;
    transition: transform ease .1s;
    transform: translate3d(-100%, 0, 0);
  }
  .convos-out .main-ui {
    transform: translate3d(0, 0, 0);
  }
  @media (min-width: 767.98px) {
    .convos {
      max-width: 330px;
    }
    .main-ui, .convos-out .main-ui {
      position: static;
      transform: none;
    }
  }

  .page-name {
    white-space: nowrap;
    overflow-x: hidden;
    text-overflow: ellipsis;
  }

  .network-waiting-container {
    display: inline-block;
    width: auto;
    height: 100%;
    margin: 0 0 0 10px;
    perspective: 1000;
    backface-visibility: hidden;
    background: transparent;
  }

  .network-waiting {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1em;
    text-align: center;
    height: 1.5em;
    width: 1.5em;
    color: white;
    border: none;
    border-radius: 50%;
    background: #91B5AA;
    box-shadow: 0 0 0 0 rgba(#91B5AA, .5);
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0% {
      transform: scale(.9);
    }
    70% {
      transform: scale(1);
      box-shadow: 0 0 0 30px rgba(#91B5AA, 0);
    }
    100% {
      transform: scale(.9);
      box-shadow: 0 0 0 0 rgba(#91B5AA, 0);
    }
  }
</style>
