<ul class="navbar-nav ml-auto">
  <li class="nav-item dropdown" bind:this={notificationsDropdown}>
    <a class="nav-link dropdown-toggle" href="javascript:void(0)" id="notificationsDropdown" title="Notifications" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      {#if $conversation.notifications === Conversation.NOTIFICATIONS_ALL}
        <span><i class="fas fa-bell"></i></span>
      {:else if $conversation.notifications === Conversation.NOTIFICATIONS_MENTIONS}
        <span><i class="far fa-bell"></i></span>
      {:else if $conversation.notifications === Conversation.NOTIFICATIONS_DIRECT}
        <span><i class="far fa-bell"></i></span>
      {:else if $conversation.notifications === Conversation.NOTIFICATIONS_NONE}
        <span><i class="fas fa-bell-slash"></i></span>
      {/if}
      <span class="sr-only">({Conversation.NOTIFICATIONS_NAME[$conversation.notifications]})</span>
    </a>
    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="notificationsDropdown">
      <h6 class="dropdown-header">
        Notification Setting
      </h6>
      {#each _keys as key}
        <a class="dropdown-item {$conversation.notifications === key ? 'active' : ''}" href="javascript:void(0)" on:click={() => setNotifications(key)}>
          {Conversation.NOTIFICATIONS_NAME[key]}
        </a>
      {/each}
    </div>
  </li>
  <li class="nav-item {$view === 'conversation' ? 'active' : ''}">
    <a class="nav-link" href="javascript:void(0)" on:click={() => navigate('/c/'+$conversation.guid)} title="Conversation">
      <i class="fas fa-comments"></i>
      {#if $view === 'conversation'}
        <span class="sr-only">(current)</span>
      {/if}
    </a>
  </li>
  <li class="nav-item {$view === 'people' ? 'active' : ''}">
    <a class="nav-link" href="javascript:void(0)" on:click={() => navigate('/c/'+$conversation.guid+'/people')} title="People ({$conversation.data.acFull.length})">
      <span class="fa-layers fa-fw">
        <i class="fas fa-users"></i>
        {#if $conversation.data.mode === Conversation.MODE_CHAT}
          <span class="fa-layers-counter fa-layers-bottom-right bg-info" style="transform: scale(0.6); bottom: -.4em; right: -.4em;">{$conversation.data.acFull.length}</span>
        {/if}
      </span>
      {#if $view === 'people'}
        <span class="sr-only">(current)</span>
      {/if}
    </a>
  </li>
  <li class="nav-item {$view === 'settings' ? 'active' : ''}">
    <a class="nav-link" href="javascript:void(0)" on:click={() => navigate('/c/'+$conversation.guid+'/settings')} title="Settings">
      <i class="fas fa-cog"></i>
      {#if $view === 'settings'}
        <span class="sr-only">(current)</span>
      {/if}
    </a>
  </li>
</ul>

<script>
  import {navigate} from '../Services/router';
  import Conversation from '../Entities/Tunnelgram/Conversation';
  import {Dropdown} from '../Services/Val/BSN';
  import {conversation, view} from '../stores';

  const _keys = Object.keys(Conversation.NOTIFICATIONS_NAME).map(parseFloat);

  let notificationsDropdown;
  let notificationsDropdownComponent;
  $: if (notificationsDropdown && !notificationsDropdownComponent) {
    notificationsDropdownComponent = new Dropdown(notificationsDropdown);
  } else if (!notificationsDropdown && notificationsDropdownComponent) {
    notificationsDropdownComponent = null;
  }

  async function setNotifications (key) {
    const notif = $conversation.saveNotificationSetting(key);
    conversation.set($conversation);
    await notif;
    conversation.set($conversation);
  }
</script>
