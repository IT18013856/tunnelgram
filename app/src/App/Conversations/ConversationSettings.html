<div class="d-flex flex-column align-items-center pt-3 mb-3">
  <h2>Conversation Settings</h2>
  <form class="d-flex flex-column justify-content-start w-100 px-2" style="max-width: 600px;" on:submit="save(event.preventDefault())">
    <div class="form-group">
      <label for="name">Name</label>
      <input type="text" class="form-control" bind:value="name" id="name" aria-describedby="nameHelp" placeholder="Name">
      <small id="nameHelp" class="form-text text-muted">Leave blank to use auto-generated name based on participants.</small>
    </div>
    <button type="submit" class="btn btn-primary">Save</button>
  </form>
  <hr />
  <div class="d-flex flex-column justify-content-start w-100 px-2 mt-3" style="max-width: 600px;">
    <div class="alert alert-info">
      If you want to start fresh, you can clear your readline. Try this if you
      keep getting notified of new messages here, even though you've seen them
      all.
    </div>
    <button type="button" class="btn btn-info" on:click="clearReadline()">Clear my Readline</button>
  </div>
  <hr />
  {#if !_confirmLeave}
    <div class="d-flex flex-column justify-content-start w-100 px-2 mt-3" style="max-width: 600px;">
      <div class="alert alert-danger">
        If you leave a conversation, all of your messages in it will be deleted.
        It may take a while, so the conversation will still be in your list for a bit.
      </div>
      <button type="button" class="btn btn-danger" on:click="confirmLeave()" disabled="{_clearingReadline}">Leave Conversation</button>
    </div>
  {:else}
    <div class="d-flex flex-column justify-content-start w-100 px-2 mt-3" style="max-width: 600px;">
      <div class="alert alert-danger">
        Are you sure you want to leave? This can't be undone.
      </div>
      <button type="button" class="btn btn-danger" on:click="leave()" disabled="{_leavingConversation}">Yes, Leave Conversation</button>
    </div>
  {/if}
</div>

<script>
  export default {
    oncreate () {
      this.set({
        name: this.store.get().conversation.decrypted.name
      });
    },

    data () {
      return {
        name: ''
      };
    },

    methods: {
      save () {
        const {name} = this.get();
        const {conversation} = this.store.get();
        if (name === '') {
          conversation.decrypted.name = null;
        } else {
          conversation.decrypted.name = name;
        }
        conversation.save();
        this.store.set({conversation});
      },

      async clearReadline () {
        this.set({_clearingReadline: true});
        const {conversation} = this.store.get();
        await conversation.clearReadline();
        this.set({_clearingReadline: false});
      },

      confirmLeave () {
        this.set({_confirmLeave: true});
      },

      leave () {
        this.set({_leavingConversation: true});
        const {conversation} = this.store.get();
        this.store.navigate('/c');
        conversation.delete();
      }
    }
  };
</script>
