<div class="d-flex flex-column align-items-center p-3">
  <form class="d-flex flex-column justify-content-start w-std-page" on:submit|preventDefault={save}>
    <h3 class="mt-3">{$conversation.data.mode === Conversation.MODE_CONVERSATION ? 'Conversation' : 'Channel'} Settings</h3>
    {#if $conversation.data.mode === Conversation.MODE_CONVERSATION || currentUserIsChannelAdmin}
      <div class="form-group">
        <label for="name">Name</label>
        <input type="text" class="form-control" bind:value={name} id="name" aria-describedby="nameHelp" placeholder="Name">
        <small id="nameHelp" class="form-text text-muted">Visible to everyone. Leave blank to use auto-generated name based on participants.</small>
      </div>
      <button type="submit" class="btn btn-primary">Save</button>
    {/if}
  </form>
  <hr />
  <div class="d-flex flex-column justify-content-start mt-3 w-std-page">
    <div class="alert alert-info">
      If you want to start fresh, you can clear your readline and notification
      settings. Try this if you keep getting notified of new messages here, even
      though you've seen them all.
    </div>
    <button type="button" class="btn btn-info" on:click={clearReadline} disabled={_clearingReadline}>Clear my Readline/Notification Settings</button>
  </div>
  <hr />
  <div class="d-flex flex-column justify-content-start mt-3 w-std-page">
    {#if !_confirmLeave}
      {#if $conversation.data.mode === Conversation.MODE_CONVERSATION}
        <div class="alert alert-danger">
          If you leave a conversation, all of your messages in it will be deleted.
          It may take a while, so the conversation will still be in your list for a bit.
        </div>
      {:else if currentUserIsChannelAdmin && $conversation.data.acFull.length === 1}
        <div class="alert alert-danger">
          You're the only admin in this channel. If you leave it, it will be
          permanently deleted.
        </div>
      {/if}
      <button type="button" class="btn btn-danger" on:click={confirmLeave} disabled={_leavingConversation}>Leave {$conversation.data.mode === Conversation.MODE_CONVERSATION ? 'Conversation' : 'Channel'}</button>
    {:else}
      <div class="alert alert-danger">
        Are you sure you want to leave? This can't be undone.
      </div>
      <button type="button" class="btn btn-danger" on:click={leave} disabled={_leavingConversation}>Yes, Leave {$conversation.data.mode === Conversation.MODE_CONVERSATION ? 'Conversation' : 'Channel'}</button>
    {/if}
  </div>
</div>

<script>
  import {navigate} from '../../Services/router';
  import Conversation from '../../Entities/Tunnelgram/Conversation';
  import {conversation, user} from '../../stores';

  let name = '';
  let _clearingReadline = false;
  let _confirmLeave = false;
  let _leavingConversation = false;

  $: currentUserIsChannelAdmin = $conversation.data.mode !== Conversation.MODE_CONVERSATION && $user.inArray($conversation.data.acFull);

  let previousConversation = null;
  $: if (previousConversation !== $conversation) {
    name = $conversation.decrypted.name;
    previousConversation = $conversation;
  };

  function save () {
    if (name === '') {
      $conversation.decrypted.name = null;
    } else {
      $conversation.decrypted.name = name;
    }
    $conversation.save();
    conversation.set($conversation);
  }

  async function clearReadline () {
    _clearingReadline = true;
    await $conversation.clearReadline();
    conversation.set($conversation);
    _clearingReadline = false;
  }

  function confirmLeave () {
    _confirmLeave = true;
  }

  function leave () {
    _leavingConversation = true;
    navigate('/c');
    $conversation.leave();
  }
</script>
