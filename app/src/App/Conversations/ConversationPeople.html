<div class="d-flex flex-column align-items-center p-3">
  <div class="d-flex flex-column justify-content-start w-std-page">
    <h3 class="mt-3">Add People</h3>
    <p>
      {#if $conversation.data.mode === Conversation.MODE_CONVERSATION}
        People you add will not be able to see any messages that were sent
        before you added them.
      {:else if $conversation.data.mode === Conversation.MODE_CHANNEL_PRIVATE}
        People you add will be able to see all previous messages in this
        channel.
      {/if}
    </p>
    <UserSearchSelector bind:this={userSearchSelector} className="d-block" disabled={_addingUser} on:user-selected={event => addUser(event.detail)} />
    {#if _addUserError != null}
      <div class="alert alert-danger mt-3 mb-0" role="alert">
        {_addUserError}
      </div>
    {/if}
    <h3 class="mt-3">People in this Conversation</h3>
    <div class="list-group mt-3 text-body">
      {#each $conversation.data.acFull as curUser, i (curUser.guid)}
        <a class="list-group-item d-flex justify-content-between align-items-center" href="javascript:void(0)" on:click={() => navigate('/u/' + curUser.data.username)}>
          <span><span class="mr-2"><Avatar bind:user={curUser} /></span> <DisplayName bind:user={curUser} /> ({curUser.data.username})</span>
          {#if $user.guid === curUser.guid}
            <span>(You)</span>
          {/if}
        </a>
      {/each}
    </div>
  </div>
</div>

<script>
  import UserSearchSelector from '../Users/UserSearchSelector';
  import Avatar from '../Users/Avatar';
  import DisplayName from '../Users/DisplayName';
  import {navigate} from '../../Services/router';
  import Conversation from '../../Entities/Tunnelgram/Conversation';
  import ErrHandler from '../../ErrHandler';
  import {conversation, user} from '../../stores';

  let _addingUser = false;
  let _addUserError = null;
  let userSearchSelector;

  $: if ($conversation && $conversation.containsSleepingReference && !$conversation._tgCalledReadyAll) {
    // Ready the conversation's referenced entities.
    $conversation._tgCalledReadyAll = true;
    $conversation.readyAll(1).then(() => {
      $conversation.containsSleepingReference = false;
      $conversation._tgCalledReadyAll = false;
      $conversation = $conversation;
    }, ErrHandler);
  }

  function addUser (user) {
    _addUserError = null;
    _addingUser = false;

    if ($user.is(user)) {
      _addUserError = 'You\'re already in this conversation.';
      userSearchSelector.focus();
      return;
    }

    if (user.inArray($conversation.data.acFull)) {
      _addUserError = 'They\'re already in this conversation.';
      userSearchSelector.focus();
      return;
    }

    $conversation.data.acFull.push(user);
    $conversation = $conversation;
    _addingUser = true;
    $conversation.save().then(() => {
      userSearchSelector.clear();
      userSearchSelector.focus();
    }, ErrHandler).finally(() => _addingUser = false);
  }
</script>
