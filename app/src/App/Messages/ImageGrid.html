<div class="d-flex flex-wrap bg-secondary rounded" style="max-width: 450px;">
  {#each images as image, index (image.name)}
    <div class="d-flex justify-content-center align-items-center">
      {#await image.thumbnail}
        <LoadingIndicator width="{image.thumbnailWidth}px" height="{image.thumbnailHeight}px" />
      {:then thumbnail}
        <a href="javascript:void(0)" on:click="showBigImage(index)" style="font-size: 0;">
          <img src="data:{image.thumbnailType};base64,{thumbnail}" alt="{image.name}" title="{image.name}" width="{image.thumbnailWidth}" height="{image.thumbnailHeight}" />
        </a>
      {:catch e}
        <span class="badge badge-warning">error</span>
      {/await}
    </div>
  {/each}
</div>
<!--
{#if _showBigImage}
  !-- TODO(hperrin): move this to outside the card so the z-index works --
  <div ref:bigImageBox class="d-flex justify-content-center align-items-center bg-dark">
    {#await _promise}
      <LoadingIndicator width="50px" height="50px" />
    {:then data}
      <img src="data:{_image.dataType};base64,{data}" alt="{_image.name}" title="{_image.name}" width="{_image.dataWidth}" style="max-width: 90%; max-height: 90%; width: auto; height: auto;" />
    {:catch e}
      <span class="badge badge-warning">error</span>
    {/await}
    <button type="button" class="btn btn-lg btn-danger rounded-circle position-absolute" style="opacity: .8; right: 1vw; top: 1vw;" on:click="set({_showBigImage: false})">
      <i class="fas fa-times text-white"></i>
    </button>
  </div>
{/if} -->

<div ref:photoswipe class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="pswp__bg"></div>
  <div class="pswp__scroll-wrap">
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    <div class="pswp__ui pswp__ui--hidden">
      <div class="pswp__top-bar">
        <div class="pswp__counter"></div>

        <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

        <!-- <button class="pswp__button pswp__button--share" title="Share"></button> -->

        <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

        <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

        <div class="pswp__preloader">
          <div class="pswp__preloader__icn">
            <div class="pswp__preloader__cut">
              <div class="pswp__preloader__donut"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
        <div class="pswp__share-tooltip"></div>
      </div>

      <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>

      <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

      <div class="pswp__caption">
        <div class="pswp__caption__center"></div>
      </div>
    </div>
  </div>
</div>

<script>
  import LoadingIndicator from '../LoadingIndicator.html';
  import PhotoSwipe from 'photoswipe/dist/photoswipe.min';
  import PhotoSwipeUI_Default from 'photoswipe/dist/photoswipe-ui-default.min';

  export default {
    oncreate () {
      const {images} = this.get();
      for (let image of images) {
        image.thumbnail.then(thumbnailSrc => {
          image.thumbnailSrc = thumbnailSrc;
        });
      }
    },

    data () {
      return {
        _showBigImage: false
      };
    },

    methods: {
      showBigImage (index) {
        // this.set({
        //   _showBigImage: true,
        //   _image,
        //   _promise: _image.data.promise()
        // });

        var pswpElement = this.refs.photoswipe;

        // build items array
        let items = this.get().images.map(image => {
          return {
            w: image.dataWidth,
            h: image.dataHeight,
            src: `data:${image.thumbnailType};base64,${image.thumbnailSrc}`,
            _loading: false,
            _image: image
          };
        });

        // define options (if needed)
        let options = {
          index,
          history: false
        };

        // Initializes and opens PhotoSwipe
        const pswp = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, options);

        pswp.listen('gettingData', function(index, item) {
          if (item._loading) {
            return;
          }
          item._loading = true;
          item._image.data.promise().then(data => {
            const newSrc = `data:${item._image.dataType};base64,${data}`;
            item.src = newSrc;
            // sets a flag that slides should be updated
            pswp.invalidateCurrItems();
            // updates the content of slides
            pswp.updateSize(true);
          });
        });

        pswp.init();
      }
    },

    components: {
      LoadingIndicator
    },

    helpers: {
      parseFloat
    }
  };
</script>

<!-- <style>
  ref:bigImageBox {
    position: fixed;
    left: 0;
    top: 0;
    z-index: 10000;
    width: 100vw;
    height: 100vh;
    overflow: auto;
  }
</style> -->
