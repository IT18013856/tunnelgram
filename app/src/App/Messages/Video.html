<div class="d-flex flex-wrap bg-secondary rounded text-white" style="max-width: 450px; font-size: 1em;">
  <div class="d-flex justify-content-center align-items-center">
    {#if resource.thumbnailPromise}
      {#await resource.thumbnailPromise}
        <LoadingIndicator width="{resource.thumbnailWidth}px" height="{resource.thumbnailHeight}px" text="Decrypting..." />
      {:then thumbnail}
        {#if _loading}
          <LoadingIndicator width="{resource.thumbnailWidth}px" height="{resource.thumbnailHeight}px" text="Decrypting..." />
        {:elseif _source}
          <video poster="{resource.thumbnailSrc}" width="{resource.thumbnailWidth}" height="{resource.thumbnailHeight}" title="{resource.name}" controls autoplay>
            <source src="{_source}" type="{resource.dataType}" />
          </video>
        {:else}
          <div class="d-flex justify-content-center align-items-center position-relative" tabindex="0" on:click="loadVideo()" style="cursor: pointer;">
            <i class="fas fa-play-circle position-absolute text-white"></i>
            <img src="{resource.thumbnailSrc}" alt="{resource.name}" title="{resource.name}" width="{resource.thumbnailWidth}" height="{resource.thumbnailHeight}" />
          </div>
        {/if}
      {:catch e}
        <span class="badge badge-warning">error</span>
      {/await}
    {:else}
      <LoadingIndicator width="{resource.thumbnailWidth}px" height="{resource.thumbnailHeight}px" text="Loading..." />
    {/if}
  </div>
</div>

<script>
  import PhotoSwipe from 'photoswipe/dist/photoswipe.min';
  import PhotoSwipeUI_Default from 'photoswipe/dist/photoswipe-ui-default.min';
  import LoadingIndicator from '../LoadingIndicator.html';
  import {crypt} from '../../Services/EncryptionService';

  export default {
    oncreate () {
      const {resource} = this.get();
      if (resource.thumbnail instanceof Uint8Array) {
        resource.thumbnailPromise = Promise.resolve(resource.thumbnail);
        const blob = new Blob([resource.thumbnail], {type: resource.thumbnailType});
        const _source = URL.createObjectURL(blob);
        resource.thumbnailSrc = _source;
      } else {
        resource.thumbnailPromise = resource.thumbnail;
        resource.thumbnail.then(data => {
          const blob = new Blob([data], {type: resource.thumbnailType});
          const _source = URL.createObjectURL(blob);
          resource.thumbnailSrc = _source;
        });
      }
      this.set({resource});
    },

    data () {
      return {
        _loading: false,
        _source: null
      };
    },

    methods: {
      loadVideo () {
        const {resource} = this.get();
        this.set({_loading: true});
        const resourcePromise = ('promise' in resource.data) ? resource.data.promise() : Promise.resolve(resource.data);
        resourcePromise.then(data => {
          const blob = new Blob([data], {type: resource.dataType});
          const _source = URL.createObjectURL(blob);
          this.set({
            _source,
            _loading: false
          });
        });
      }
    },

    components: {
      LoadingIndicator
    },

    helpers: {
      parseFloat
    }
  };
</script>
